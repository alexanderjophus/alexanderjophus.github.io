<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>4/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (finishing the project) | Alexander Joseph</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="DISCLAIMER: This is intending to be a learning exercise and may not be the most efficient way to do things. This is intended to be a multi-part blog post describing how to create a recommender gRPC service in Go.
For the full source code, visit trelore/iris-classification.
Intro We&rsquo;ll update our server to load the theta.bin model we created in post 3. We&rsquo;ll update the Predict function to use the model in the server."><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="4/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (finishing the project)"><meta property="og:description" content="DISCLAIMER: This is intending to be a learning exercise and may not be the most efficient way to do things. This is intended to be a multi-part blog post describing how to create a recommender gRPC service in Go.
For the full source code, visit trelore/iris-classification.
Intro We&rsquo;ll update our server to load the theta.bin model we created in post 3. We&rsquo;ll update the Predict function to use the model in the server."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/ml-grpc-4/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-07T18:37:11+01:00"><meta property="article:modified_time" content="2021-11-07T18:37:11+01:00"><meta itemprop=name content="4/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (finishing the project)"><meta itemprop=description content="DISCLAIMER: This is intending to be a learning exercise and may not be the most efficient way to do things. This is intended to be a multi-part blog post describing how to create a recommender gRPC service in Go.
For the full source code, visit trelore/iris-classification.
Intro We&rsquo;ll update our server to load the theta.bin model we created in post 3. We&rsquo;ll update the Predict function to use the model in the server."><meta itemprop=datePublished content="2021-11-07T18:37:11+01:00"><meta itemprop=dateModified content="2021-11-07T18:37:11+01:00"><meta itemprop=wordCount content="577"><meta itemprop=keywords content="iris,"><meta name=twitter:card content="summary"><meta name=twitter:title content="4/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (finishing the project)"><meta name=twitter:description content="DISCLAIMER: This is intending to be a learning exercise and may not be the most efficient way to do things. This is intended to be a multi-part blog post describing how to create a recommender gRPC service in Go.
For the full source code, visit trelore/iris-classification.
Intro We&rsquo;ll update our server to load the theta.bin model we created in post 3. We&rsquo;ll update the Predict function to use the model in the server."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Alexander Joseph</a><div class="flex-l items-center"></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=http://example.org/posts/ml-grpc-4/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=http://example.org/posts/ml-grpc-4/&text=4/4%20CREATING%20A%20ML%20CLASSIFIER%20GRPC%20SERVICE%20WITH%20GOLANG%20%28finishing%20the%20project%29" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=http://example.org/posts/ml-grpc-4/&title=4/4%20CREATING%20A%20ML%20CLASSIFIER%20GRPC%20SERVICE%20WITH%20GOLANG%20%28finishing%20the%20project%29" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">4/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (finishing the project)</h1><time class="f6 mv4 dib tracked" datetime=2021-11-07T18:37:11+01:00>November 7, 2021</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>DISCLAIMER: This is intending to be a learning exercise and may not be the most efficient way to do things. This is intended to be a multi-part blog post describing how to create a recommender gRPC service in Go.</p><p>For the full source code, visit <a href=https://github.com/trelore/iris-classification>trelore/iris-classification</a>.</p><h2 id=intro>Intro</h2><p>We&rsquo;ll update our server to load the <code>theta.bin</code> model we created in post 3.
We&rsquo;ll update the <code>Predict</code> function to use the model in the server.</p><h2 id=load-the-model>Load the model</h2><p>There&rsquo;s no point reading in the model every time we make a request, it&rsquo;ll cause the system to be slower than it needs to.
The question becomes, how much can we do in the server initialisation and how much do we need in the function.
The answer to that is that we need a tensor Dense matrix representation of the model, and the rest we can do in the function.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// S Implements the IrisClassificationService service
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>S</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>thetaT</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>tensor</span>.<span style=color:#a6e22e>Dense</span>
	<span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>UnimplementedIrisClassificationServiceServer</span>
}
</code></pre></div><p>Our server should look something like that.
If you followed part 3, it should be clear what we&rsquo;re about to chuck into the server, if you need to read more refer to that post and its references.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// New returns a new S
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>() <span style=color:#a6e22e>S</span> {
	<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>models</span>.<span style=color:#a6e22e>Data</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#e6db74>&#34;theta.bin&#34;</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
	}
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>thetaT</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>tensor</span>.<span style=color:#a6e22e>Dense</span>
	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>gob</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>b</span>)).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>thetaT</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>S</span>{<span style=color:#a6e22e>thetaT</span>: <span style=color:#a6e22e>thetaT</span>}
}
</code></pre></div><p>As always, we read in the file through our models package which embeds the model.
After it&rsquo;s read, we decode the bytes into a tensor Dense matrix.</p><h2 id=combining-user-input-with-our-model>Combining user input with our model</h2><p>Lastly, let&rsquo;s get our user input, the model and combine the two.
This should allow us to predict what type of iris the user input.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Predict implements proto
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>S</span>) <span style=color:#a6e22e>Predict</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>PredictRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>PredictResponse</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>g</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gorgonia</span>.<span style=color:#a6e22e>NewGraph</span>()
	<span style=color:#a6e22e>theta</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gorgonia</span>.<span style=color:#a6e22e>NodeFromAny</span>(<span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>thetaT</span>, <span style=color:#a6e22e>gorgonia</span>.<span style=color:#a6e22e>WithName</span>(<span style=color:#e6db74>&#34;theta&#34;</span>))

	<span style=color:#a6e22e>values</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>float64</span>{
		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetSepalLength</span>(),
		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetSepalWidth</span>(),
		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetPetalLength</span>(),
		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>GetPetalWidth</span>(),
		<span style=color:#ae81ff>1.0</span>,
	}
	<span style=color:#a6e22e>xT</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tensor</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>tensor</span>.<span style=color:#a6e22e>WithBacking</span>(<span style=color:#a6e22e>values</span>))
	<span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gorgonia</span>.<span style=color:#a6e22e>NodeFromAny</span>(<span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>xT</span>, <span style=color:#a6e22e>gorgonia</span>.<span style=color:#a6e22e>WithName</span>(<span style=color:#e6db74>&#34;x&#34;</span>))
	<span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gorgonia</span>.<span style=color:#a6e22e>Mul</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>theta</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>Internal</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
	}
	<span style=color:#a6e22e>machine</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gorgonia</span>.<span style=color:#a6e22e>NewTapeMachine</span>(<span style=color:#a6e22e>g</span>)
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>machine</span>.<span style=color:#a6e22e>Close</span>()

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>machine</span>.<span style=color:#a6e22e>RunAll</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>Internal</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
	}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>class</span> <span style=color:#66d9ef>string</span>
	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Round</span>(<span style=color:#a6e22e>y</span>.<span style=color:#a6e22e>Value</span>().<span style=color:#a6e22e>Data</span>().(<span style=color:#66d9ef>float64</span>)) {
	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span>:
		<span style=color:#a6e22e>class</span> = <span style=color:#e6db74>&#34;setosa&#34;</span>
	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span>:
		<span style=color:#a6e22e>class</span> = <span style=color:#e6db74>&#34;virginica&#34;</span>
	<span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span>:
		<span style=color:#a6e22e>class</span> = <span style=color:#e6db74>&#34;versicolor&#34;</span>
	<span style=color:#66d9ef>default</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>Internal</span>, <span style=color:#e6db74>&#34;unknown iris&#34;</span>)
	}
	<span style=color:#a6e22e>machine</span>.<span style=color:#a6e22e>Reset</span>()
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>PredictResponse</span>{
		<span style=color:#a6e22e>Predicition</span>: <span style=color:#a6e22e>class</span>,
	}, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>This should look almost identical to the test we ran in post 3, but with a few key changes.
We now get the values from user input, and we assign the classification to a variable which we then use on the response.
We can also test this using evans (as we saw in post 2), and you should see something like this:</p><pre><code>iris_classification.v1.IrisClassificationService@127.0.0.1:32400&gt; call Predict
sepal_length (TYPE_DOUBLE) =&gt; 5.1
sepal_width (TYPE_DOUBLE) =&gt; 3.5
petal_length (TYPE_DOUBLE) =&gt; 1.4
petal_width (TYPE_DOUBLE) =&gt; 0.2
{
  &quot;predicition&quot;: &quot;setosa&quot;
}
</code></pre><h2 id=closing-remarks-and-future-steps>Closing remarks and future steps</h2><p>Overall this project was very fun, I stopped and started more times than I&rsquo;d like to count.
Like everything each iteration became better and better and I&rsquo;m really happy with the end result.</p><p>Future steps:</p><ul><li>&lsquo;Productionise&rsquo; the ML service with tracing, logs, metrics etc.</li><li>Building the ML model through something like Kubeflow for auditing and question answering of <em>why</em> we get certain answers.</li><li>Pick a better ML project, we covered the fundamentals with this project, it&rsquo;d be fun to create a movie recommender given user input.</li></ul><ul class=pa0><li class=list><a href=/tags/iris class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">iris</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/posts/ml-grpc-3/>3/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (creating a model)</a></li><li class=mb2><a href=/posts/ml-grpc-2/>2/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (implementing a server)</a></li><li class=mb2><a href=/posts/ml-grpc-1/>1/4 CREATING A ML CLASSIFIER GRPC SERVICE WITH GOLANG (the gRPC bit)</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=http://example.org/>&copy; Alexander Joseph 2021</a><div></div></div></footer></body></html>