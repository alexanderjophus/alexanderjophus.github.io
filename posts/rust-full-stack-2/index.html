<!doctype html><html lang=en><head><title>Creating a full stack web app in Rust 2/3 ¬∑ Alexander Jophus</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Alexander Jophus"><meta name=description content="Source Code
Intro/Recap  Link to heading   Last post we talked about how to use Pavex and Diesel to create a simple web server. We stopped at the point of being able to run it locally, in our specific use case we were able to search through a list of Digimon, and even get specific Digimon by name.
In this post, we&rsquo;ll be deploying the application through shuttle. üöÄ"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating a full stack web app in Rust 2/3"><meta name=twitter:description content="Source Code
Intro/Recap  Link to heading   Last post we talked about how to use Pavex and Diesel to create a simple web server. We stopped at the point of being able to run it locally, in our specific use case we were able to search through a list of Digimon, and even get specific Digimon by name.
In this post, we&rsquo;ll be deploying the application through shuttle. üöÄ"><meta property="og:title" content="Creating a full stack web app in Rust 2/3"><meta property="og:description" content="Source Code
Intro/Recap  Link to heading   Last post we talked about how to use Pavex and Diesel to create a simple web server. We stopped at the point of being able to run it locally, in our specific use case we were able to search through a list of Digimon, and even get specific Digimon by name.
In this post, we&rsquo;ll be deploying the application through shuttle. üöÄ"><meta property="og:type" content="article"><meta property="og:url" content="https://example.com/posts/rust-full-stack-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-17T17:20:57+01:00"><meta property="article:modified_time" content="2024-04-17T17:20:57+01:00"><link rel=canonical href=https://example.com/posts/rust-full-stack-2/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.5adbe72fc41dcfb852215b84695288939b6b606db73238bd3ee936469572fc9c.css integrity="sha256-WtvnL8Qdz7hSIVuEaVKIk5trYG23Mji9Puk2RpVy/Jw=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q0FK4PHVCM"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Q0FK4PHVCM',{anonymize_ip:!1})}</script></head><body class="preload-transitions colorscheme-light"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Alexander Jophus</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://example.com/posts/rust-full-stack-2/>Creating a full stack web app in Rust 2/3</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-04-17T17:20:57+01:00>April 17, 2024</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/rust/>rust</a></span></div></div></header><div class=post-content><p><a href=https://github.com/alexanderjophus/cyber-sleuth target=_blank>Source Code</a></p><h2 id=introrecap>Intro/Recap
<a class=heading-link href=#introrecap><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Last post we talked about how to use Pavex and Diesel to create a simple web server.
We stopped at the point of being able to run it locally, in our specific use case we were able to search through a list of Digimon, and even get specific Digimon by name.</p><p>In this post, we&rsquo;ll be deploying the application through shuttle. üöÄ</p><p>As a recap, here&rsquo;s where we are:</p><ul><li>‚úÖ Server - Pavex</li><li>‚úÖ Database - Diesel</li><li>üöß Server Hosting - Shuttle</li><li>‚ùå Frontend - Dioxus</li></ul><h2 id=shuttle>Shuttle
<a class=heading-link href=#shuttle><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>From the <a href=https://shuttle.rs/ target=_blank>Shuttle</a> website:</p><blockquote><p>Build & ship a backend without writing any infrastructure files. Instead get your infrastructure definitions from your code function signatures and annotations.</p></blockquote><p>I&rsquo;ve used it for discord bots in the past and it&rsquo;s been helpful.
Provided the framework you&rsquo;re using is supported, it&rsquo;s a great way to deploy your application without having to worry about the infrastructure.</p><p>We&rsquo;ll assume you have a shuttle account, and understand the basics of shuttle at this point.
If you don&rsquo;t, check out their docs, play around with it, it&rsquo;s super fun!</p><h2 id=shuttle--pavex>Shuttle &lt;> Pavex
<a class=heading-link href=#shuttle--pavex><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Remember when I said that shuttle needs to support the framework you&rsquo;re using?
Well, Pavex isn&rsquo;t supported by shuttle, so we&rsquo;ll have to do some work to get it to work.</p><p>The first thing to note is that shuttle does work in workspaces with multiple crates.
This means that we can have a workspace with our classic 3 Pavex crates, and a separate crate for the shuttle wrapper.</p><h3 id=shuttle-wrapper>Shuttle Wrapper
<a class=heading-link href=#shuttle-wrapper><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Typically, with Shuttle, you&rsquo;d have an entry point that looks something like this:</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#0f0;font-weight:700>#[shuttle_runtime::main]</span>
<span style=color:#fff;font-weight:700>async</span> <span style=color:#fff;font-weight:700>fn</span> serenity(
    <span style=color:#0f0;font-weight:700>#[shuttle_runtime::Secrets]</span> secrets: SecretStore,
) -&gt; shuttle_serenity::ShuttleSerenity {
    <span style=color:#007f7f>// rust code here
</span><span style=color:#007f7f></span>}
</code></pre></div><p>where <code>shuttle_serenity</code> is the shuttle maintained crate for the serenity framework.
So, copilots first thought was to hallucinate a <code>shuttle_pavex</code> crate. Helpful.</p><p>This file <a href=https://github.com/shuttle-hq/shuttle/blob/3e63caa290c4e1e9fc745fb073ed9c5b39f098a3/services/README.md target=_blank>services/README.md</a>, was a huge hint as to how crates like <code>shuttle_serenity</code> work.
All we need to do is implement <code>shuttle_runtime::Service</code> for a given <code>PavexService</code> struct.
Our <code>shuttle_pavex.rs</code> file will look something like this:</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#0ff;font-weight:700>/// A wrapper type for [pavex::server::Server] so we can implement [shuttle_runtime::Service] for it.
</span><span style=color:#0ff;font-weight:700></span><span style=color:#fff;font-weight:700>pub</span> <span style=color:#fff;font-weight:700>struct</span> PavexService(<span style=color:#fff;font-weight:700>pub</span> pavex::server::Server);

<span style=color:#0f0;font-weight:700>#[shuttle_runtime::async_trait]</span>
<span style=color:#fff;font-weight:700>impl</span> shuttle_runtime::Service <span style=color:#fff;font-weight:700>for</span> PavexService {
    <span style=color:#fff;font-weight:700>async</span> <span style=color:#fff;font-weight:700>fn</span> bind(<span style=color:#fff;font-weight:700>mut</span> self, addr: SocketAddr) -&gt; <span style=color:#fff;font-weight:700>Result</span>&lt;(), Error&gt; {
        <span style=color:#fff;font-weight:700>let</span> application_state = build_application_state().<span style=color:#fff;font-weight:700>await</span>;

        <span style=color:#fff;font-weight:700>let</span> server = self
            .<span style=color:#ff0;font-weight:700>0</span>
            .bind(addr)
            .<span style=color:#fff;font-weight:700>await</span>
            .expect(<span style=color:#0ff;font-weight:700>&#34;Failed to bind the server TCP listener&#34;</span>);

        tracing::info!(<span style=color:#0ff;font-weight:700>&#34;Starting to listen for incoming requests at {}&#34;</span>, addr);

        run(server, application_state).<span style=color:#fff;font-weight:700>await</span>;

        <span style=color:#fff;font-weight:700>Ok</span>(())
    }
}
</code></pre></div><p>There&rsquo;s a lot to digest, so let&rsquo;s go slowly.</p><p>First, we define a struct <code>PavexService</code> that wraps a <code>pavex::server::Server</code>.
This is so we can implement the <code>shuttle_runtime::Service</code> trait for it.
The trait requires us to implement a <code>bind</code> function, which is where we&rsquo;ll set up our server.</p><p>For context, we&rsquo;re taking inspiration (or copying, if you will) from the <code>server</code> crate in Pavex.
This uses the <code>server_sdk</code> crates <code>build_application_state</code> and <code>run</code> functions to set up the server.
We&rsquo;re doing the same here, but with our own <code>PavexService</code> struct.</p><p>The <code>build_application_state</code> function is where we set up our application state - this will now be consistent between <code>cargo px run</code> and <code>cargo shuttle run</code>.
We then bind the address to the server.
Finally, we <code>run</code> the server with the application state.</p><p>Job&rsquo;s a good&rsquo;un.</p><h3 id=shuttle-pavex>Shuttle Pavex
<a class=heading-link href=#shuttle-pavex><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Now, let&rsquo;s dive over to our <code>main.rs</code> file and see how we can use this.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#fff;font-weight:700>use</span> pavex::server::Server;
<span style=color:#fff;font-weight:700>use</span> shuttle_runtime::SecretStore;

<span style=color:#fff;font-weight:700>mod</span> shuttle_pavex;

<span style=color:#0f0;font-weight:700>#[shuttle_runtime::main]</span>
<span style=color:#fff;font-weight:700>async</span> <span style=color:#fff;font-weight:700>fn</span> pavex(<span style=color:#0f0;font-weight:700>#[shuttle_runtime::Secrets]</span> secrets: SecretStore) -&gt; shuttle_pavex::ShuttlePavex {
    std::env::set_var(
        <span style=color:#0ff;font-weight:700>&#34;APP_PROFILE&#34;</span>,
        secrets
            .get(<span style=color:#0ff;font-weight:700>&#34;APP_PROFILE&#34;</span>)
            .unwrap_or(<span style=color:#0ff;font-weight:700>&#34;development&#34;</span>.to_string()),
    );

    <span style=color:#fff;font-weight:700>let</span> _ = dotenvy::dotenv();

    <span style=color:#fff;font-weight:700>let</span> server = Server::new();

    <span style=color:#fff;font-weight:700>let</span> shuttle_px = shuttle_pavex::PavexService(server);

    <span style=color:#fff;font-weight:700>Ok</span>(shuttle_px)
}
</code></pre></div><p>There&rsquo;s a bit to unpack here, so let&rsquo;s break it down line by line.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#0f0;font-weight:700>#[shuttle_runtime::main]</span>
<span style=color:#fff;font-weight:700>async</span> <span style=color:#fff;font-weight:700>fn</span> pavex(<span style=color:#0f0;font-weight:700>#[shuttle_runtime::Secrets]</span> secrets: SecretStore) -&gt; shuttle_pavex::ShuttlePavex {
    <span style=color:#007f7f>// code here
</span><span style=color:#007f7f></span>}
</code></pre></div><p>The entry point to our application when running through shuttle is the function with the <code>#[shuttle_runtime::main]</code> attribute.
This function takes a <code>SecretStore</code> as an argument, which is where we can store secrets for our application.
We could pass in database URIs, API keys, etc. For our demo we&rsquo;re going to pass in the APP_PROFILE, which is either <code>development</code> or <code>production</code>.</p><p>Next up we set an environment variable based on the secret.
There&rsquo;s a bit of funkiness here, in the premade <code>server</code> crate from Pavex, it reads env variables for the <code>APP_PROFILE</code>.
That&rsquo;s why we set the env var here, so that the server knows what profile to run in.</p><p>After that we have &ldquo;the rest of the fucking owl&rdquo;.</p><div class=highlight><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust>    <span style=color:#fff;font-weight:700>let</span> server = Server::new();

    <span style=color:#fff;font-weight:700>let</span> shuttle_px = shuttle_pavex::PavexService(server);

    <span style=color:#fff;font-weight:700>Ok</span>(shuttle_px)
</code></pre></div><p>This loosely follows what we have in the original pavex <code>server</code> crate (the entrypoint if you were to run <code>cargo px run</code>, or the dockerised version of the app).
My advice if you want to dive deeper is to look at the Pavex docs and find Luca&rsquo;s RustNation UK talk on Pavex.</p><h2 id=part-2-conclusion>Part 2 Conclusion
<a class=heading-link href=#part-2-conclusion><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Shuttle is <em>slick</em>.
It supports most Rust frameworks, it is a delight to work with, and the discord server is lively and helpful.</p><p>I&rsquo;d knock points off for not supporting Pavex out of the box, but I think with Pavex&rsquo;s non-conventional design it&rsquo;s tricky to do, and it was very straight forward to actually implement.
So, no, no points deducted. 10/10.</p><p>You should not only be able to run <code>cargo px run</code> but also <code>cargo shuttle run</code> too.</p><p>You can now also take this further, and deploy to shuttle in CI.
But I&rsquo;ll leave that as an exercise to the reader.</p><p>Join me next time where I&rsquo;ll wrangle a front end onto this project (also written in Rust, because why not?).</p><p>Until next time, happy coding! üöÄ</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2025
Alexander Jophus
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.369d90111ae4409b4e51de5efd23a46b92663fcc82dc9a0efde7f70bffc3f949.js integrity="sha256-Np2QERrkQJtOUd5e/SOka5JmP8yC3JoO/ef3C//D+Uk="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q0FK4PHVCM"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Q0FK4PHVCM',{anonymize_ip:!1})}</script></body></html>